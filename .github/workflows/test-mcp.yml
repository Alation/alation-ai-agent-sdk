name: Test MCP
on:
  workflow_call:

permissions:
  contents: read
  actions: read

jobs:
  test-mcp:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - run: pip install artifacts/**/alation_ai_agent_sdk*.whl pytest==8.3.5
      - run: pip install artifacts/**/alation_ai_agent_mcp*.whl

      - run: |
          set +e
          pytest python/dist-mcp/tests/test_mcp_server.py --tb=line --maxfail=50 --disable-warnings -v --no-header > mcp-test-output.log 2>&1
          echo $? > mcp-exit-code.txt
          set -e

      - run: |
          TEST_EXIT_CODE=$(cat mcp-exit-code.txt)
          
          # Extract test statistics (using more portable regex)
          TOTAL=$(grep -o 'collected [0-9]*' mcp-test-output.log | grep -o '[0-9]*' || echo "0")
          PASSED=$(grep -o '[0-9]* passed' mcp-test-output.log | grep -o '[0-9]*' || echo "0")
          FAILED=$(grep -o '[0-9]* failed' mcp-test-output.log | grep -o '[0-9]*' || echo "0")
          ERRORS=$(grep -o '[0-9]* error' mcp-test-output.log | grep -o '[0-9]*' || echo "0")
          SKIPPED=$(grep -o '[0-9]* skipped' mcp-test-output.log | grep -o '[0-9]*' || echo "0")
          
          # Calculate total failures (failed + errors)
          TOTAL_FAILED=$((FAILED + ERRORS))
          
          {
            echo "### 🔧 MCP Test Summary"
            echo ""
            echo "| Suite | Total | Passed | Failed | Errors | Skipped |"
            echo "|-------|-------|--------|--------|--------|---------|"
            echo "| MCP   | $TOTAL | $PASSED | $FAILED | $ERRORS | $SKIPPED |"
            
            if [ "$TOTAL_FAILED" -gt 0 ]; then
              echo ""
              echo "**❌ Failed Tests Details:**"
              echo '```'
              
              # Extract failed test details with better parsing
              grep -E "FAILED|ERROR" mcp-test-output.log | head -20 || echo "No detailed failure info found"
              
              if [ $(grep -c -E "FAILED|ERROR" mcp-test-output.log) -gt 20 ]; then
                echo ""
                echo "... (showing first 20 failures, check logs for complete details)"
              fi
              
              echo '```'
              
              # Add test execution summary if available
              if grep -q "short test summary info" mcp-test-output.log; then
                echo ""
                echo "**📋 Test Summary:**"
                echo '```'
                sed -n '/short test summary info/,/==/p' mcp-test-output.log | head -30 || echo "Summary not available"
                echo '```'
              fi
            fi
          } > mcp-test-summary.md
          
          # Always show the output for debugging
          echo "=== FULL TEST OUTPUT ==="
          cat mcp-test-output.log

      - uses: actions/upload-artifact@v4
        with:
          name: mcp-test-summary
          path: mcp-test-summary.md

      - run: exit $(cat mcp-exit-code.txt)
